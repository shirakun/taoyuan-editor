<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¡ƒæºä¹¡ â€” å­˜æ¡£ç¼–è¾‘å™¨</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');

    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --surface2: #1c2333;
      --border: #30363d;
      --gold: #c8a45c;
      --gold-dim: #a68a46;
      --gold-glow: rgba(200, 164, 92, .18);
      --text: #e6e1d3;
      --text2: #8b949e;
      --green: #3fb950;
      --red: #f85149;
      --blue: #58a6ff;
      --purple: #bc8cff;
      --radius: 8px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans SC', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* === Header === */
    .header {
      background: linear-gradient(135deg, #1a1208 0%, #0d1117 100%);
      border-bottom: 1px solid var(--border);
      padding: 20px 32px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header h1 {
      font-size: 22px;
      font-weight: 700;
      color: var(--gold);
    }

    .header span {
      color: var(--text2);
      font-size: 13px;
    }

    /* === Layout === */
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px;
    }

    /* === Dropzone === */
    .dropzone {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 48px;
      text-align: center;
      cursor: pointer;
      transition: all .25s;
      background: var(--surface);
    }

    .dropzone:hover,
    .dropzone.drag-over {
      border-color: var(--gold);
      background: var(--gold-glow);
    }

    .dropzone h2 {
      color: var(--gold);
      margin-bottom: 8px;
      font-size: 18px;
    }

    .dropzone p {
      color: var(--text2);
      font-size: 14px;
    }

    .dropzone input {
      display: none;
    }

    /* === Toolbar === */
    .toolbar {
      display: flex;
      gap: 10px;
      margin: 20px 0;
      flex-wrap: wrap;
      align-items: center;
    }

    .toolbar .info {
      flex: 1;
      color: var(--text2);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .toolbar .info .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--green);
      display: inline-block;
    }

    /* === Buttons === */
    .btn {
      border: none;
      border-radius: 6px;
      padding: 9px 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all .2s;
      font-family: inherit;
    }

    .btn-gold {
      background: var(--gold);
      color: #1a1208;
    }

    .btn-gold:hover {
      background: #d4b06a;
      transform: translateY(-1px);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }

    .btn-outline:hover {
      border-color: var(--gold);
      color: var(--gold);
    }

    .btn-red {
      background: var(--red);
      color: #fff;
    }

    .btn-red:hover {
      opacity: .85;
    }

    .btn:disabled {
      opacity: .4;
      cursor: not-allowed;
    }

    /* === Tabs === */
    .tabs {
      display: flex;
      gap: 2px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .tab {
      padding: 10px 20px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      background: none;
      color: var(--text2);
      border-bottom: 2px solid transparent;
      font-family: inherit;
      transition: all .2s;
    }

    .tab:hover {
      color: var(--text);
    }

    .tab.active {
      color: var(--gold);
      border-bottom-color: var(--gold);
    }

    /* === Sections === */
    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* === Cards === */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 500;
      color: var(--gold);
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* === Forms === */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 14px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field label {
      font-size: 13px;
      color: var(--text2);
    }

    .field input,
    .field select {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 12px;
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      outline: none;
      transition: border-color .2s;
    }

    .field input:focus,
    .field select:focus {
      border-color: var(--gold);
    }

    .field input[type="number"] {
      -moz-appearance: textfield;
    }

    /* === Tool grid === */
    .tools-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }

    .tool-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .tool-card .tool-name {
      font-size: 14px;
      font-weight: 500;
    }

    .tool-card select {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 6px 8px;
      color: var(--text);
      font-size: 13px;
      font-family: inherit;
    }

    /* === Weapon list === */
    .weapon-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .weapon-row {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px 14px;
    }

    .weapon-row.equipped {
      border-color: var(--gold);
      box-shadow: 0 0 12px var(--gold-glow);
    }

    .weapon-row select,
    .weapon-row button {
      font-family: inherit;
    }

    .weapon-row select {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 4px;
      padding: 5px 8px;
      font-size: 13px;
    }

    .weapon-row .weapon-info {
      flex: 1;
      font-size: 13px;
      color: var(--text2);
    }

    .weapon-row .weapon-stats {
      font-size: 12px;
      color: var(--text2);
    }

    .weapon-row .btn-sm {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: none;
      color: var(--text2);
      cursor: pointer;
      font-family: inherit;
    }

    .weapon-row .btn-sm:hover {
      border-color: var(--red);
      color: var(--red);
    }

    .weapon-row .btn-equip {
      border-color: var(--gold);
      color: var(--gold);
    }

    .weapon-row .btn-equip:hover {
      background: var(--gold-glow);
    }

    .add-weapon-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .add-weapon-row select {
      flex: 1;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 6px;
      padding: 8px;
      font-size: 13px;
      font-family: inherit;
    }

    /* === Inventory table === */
    .inv-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .inv-table th {
      text-align: left;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      color: var(--text2);
      font-weight: 500;
      font-size: 12px;
    }

    .inv-table td {
      padding: 6px 12px;
      border-bottom: 1px solid #21262d;
    }

    .inv-table input {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 4px 8px;
      color: var(--text);
      font-size: 13px;
      width: 80px;
      font-family: inherit;
    }

    .inv-table input:focus {
      border-color: var(--gold);
      outline: none;
    }

    .inv-table .del-btn {
      background: none;
      border: none;
      color: var(--text2);
      cursor: pointer;
      font-size: 16px;
      padding: 0 4px;
    }

    .inv-table .del-btn:hover {
      color: var(--red);
    }

    /* === Farm grid === */
    .farm-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 8px;
    }

    .plot-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px;
      font-size: 12px;
      cursor: pointer;
      transition: all .2s;
    }

    .plot-card:hover {
      border-color: var(--gold);
    }

    .plot-card .plot-id {
      color: var(--text2);
      margin-bottom: 4px;
    }

    .plot-card .plot-crop {
      color: var(--green);
      font-weight: 500;
    }

    .plot-card .plot-status {
      color: var(--text2);
      margin-top: 2px;
    }

    .plot-card.empty .plot-crop {
      color: var(--text2);
    }

    .plot-card.infested {
      border-color: var(--red);
    }

    .plot-card.weedy {
      border-color: #d29922;
    }

    /* === Modal === */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, .6);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 24px;
      width: 420px;
      max-width: 90vw;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal h3 {
      color: var(--gold);
      margin-bottom: 16px;
      font-size: 16px;
    }

    .modal .field {
      margin-bottom: 12px;
    }

    .modal .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    /* === Toast === */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 20px;
      font-size: 14px;
      z-index: 200;
      transform: translateY(80px);
      opacity: 0;
      transition: all .3s ease;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast.success {
      border-color: var(--green);
    }

    .toast.error {
      border-color: var(--red);
    }

    /* === JSON raw === */
    .json-raw {
      width: 100%;
      min-height: 400px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      color: var(--text);
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      resize: vertical;
      outline: none;
    }

    .json-raw:focus {
      border-color: var(--gold);
    }

    /* batch actions */
    .batch-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
  </style>
</head>

<body>

  <div class="header">
    <h1>ğŸ¡ æ¡ƒæºä¹¡ å­˜æ¡£ç¼–è¾‘å™¨</h1>
    <span>æ”¯æŒ .tyx åŠ å¯†å­˜æ¡£çš„è§£å¯†ç¼–è¾‘ä¸é‡æ–°åŠ å¯†å¯¼å‡º</span>
  </div>

  <div class="container">
    <!-- Dropzone -->
    <div id="dropzone" class="dropzone">
      <h2>ğŸ“‚ æ‹–æ‹½ .tyx å­˜æ¡£æ–‡ä»¶åˆ°è¿™é‡Œ</h2>
      <p>æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ Â· æ”¯æŒæ¡ƒæºä¹¡æ¸¸æˆå­˜æ¡£æ ¼å¼</p>
      <input type="file" id="fileInput" accept=".tyx">
    </div>
    <div id="keyRow" style="margin-top:12px;display:flex;align-items:center;gap:8px;justify-content:center">
      <label style="color:var(--text2);font-size:13px">ğŸ”‘ å¯†é’¥</label>
      <input id="encKey" type="text" value="taoyuanxiang_2024_secret"
        style="width:280px;background:var(--bg);border:1px solid var(--border);color:var(--gold);border-radius:6px;padding:6px 10px;font-size:13px;font-family:monospace;text-align:center">
    </div>

    <!-- Editor (hidden until file loaded) -->
    <div id="editor" style="display:none">
      <div class="toolbar">
        <div class="info"><span class="dot"></span> <span id="fileInfo"></span></div>
        <div style="display:flex;align-items:center;gap:6px">
          <label style="color:var(--text2);font-size:12px">ğŸ”‘</label>
          <input id="encKeyEditor" type="text" value="taoyuanxiang_2024_secret"
            style="width:220px;background:var(--bg);border:1px solid var(--border);color:var(--gold);border-radius:4px;padding:4px 8px;font-size:12px;font-family:monospace">
        </div>
        <button class="btn btn-outline" onclick="loadFile()">ğŸ“‚ åŠ è½½å…¶ä»–æ–‡ä»¶</button>
        <button class="btn btn-gold" onclick="exportSave()">ğŸ’¾ å¯¼å‡º .tyx</button>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="player">ğŸ‘¤ ç©å®¶</button>
        <button class="tab" data-tab="tools">ğŸ”§ å·¥å…·</button>
        <button class="tab" data-tab="weapons">âš”ï¸ æ­¦å™¨</button>
        <button class="tab" data-tab="inventory">ğŸ’ èƒŒåŒ…</button>
        <button class="tab" data-tab="farm">ğŸŒ¾ å†œç”°</button>
        <button class="tab" data-tab="raw">ğŸ“ åŸå§‹JSON</button>
      </div>

      <!-- Player -->
      <div id="sec-player" class="section active">
        <div class="card">
          <div class="card-title">ğŸ“Š åŸºæœ¬ä¿¡æ¯</div>
          <div class="form-grid">
            <div class="field"><label>ç©å®¶å</label><input id="p-name" type="text"></div>
            <div class="field"><label>æ€§åˆ«</label>
              <select id="p-gender">
                <option value="male">ç”·</option>
                <option value="female">å¥³</option>
              </select>
            </div>
            <div class="field"><label>é‡‘é’±</label><input id="p-money" type="number"></div>
            <div class="field"><label>ä½“åŠ›</label><input id="p-stamina" type="number"></div>
            <div class="field"><label>æœ€å¤§ä½“åŠ›</label><input id="p-maxStamina" type="number"></div>
            <div class="field"><label>ä½“åŠ›ä¸Šé™ç­‰çº§</label><input id="p-staminaCap" type="number"></div>
            <div class="field"><label>HP</label><input id="p-hp" type="number"></div>
            <div class="field"><label>åŸºç¡€æœ€å¤§HP</label><input id="p-baseMaxHp" type="number"></div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">ğŸŒ¤ï¸ æ¸¸æˆçŠ¶æ€</div>
          <div class="form-grid">
            <div class="field"><label>å¹´ä»½</label><input id="g-year" type="number"></div>
            <div class="field"><label>å­£èŠ‚</label>
              <select id="g-season">
                <option value="spring">æ˜¥</option>
                <option value="summer">å¤</option>
                <option value="autumn">ç§‹</option>
                <option value="winter">å†¬</option>
              </select>
            </div>
            <div class="field"><label>å¤©æ•°</label><input id="g-day" type="number"></div>
            <div class="field"><label>å°æ—¶</label><input id="g-hour" type="number"></div>
            <div class="field"><label>ä»Šæ—¥å¤©æ°”</label>
              <select id="g-weather">
                <option value="sunny">æ™´</option>
                <option value="rainy">é›¨</option>
                <option value="windy">é£</option>
                <option value="snowy">é›ª</option>
              </select>
            </div>
            <div class="field"><label>æ˜æ—¥å¤©æ°”</label>
              <select id="g-tomorrow">
                <option value="sunny">æ™´</option>
                <option value="rainy">é›¨</option>
                <option value="windy">é£</option>
                <option value="snowy">é›ª</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Tools -->
      <div id="sec-tools" class="section">
        <div class="card">
          <div class="card-title">ğŸ”§ å·¥å…·å‡çº§</div>
          <div class="batch-row">
            <button class="btn btn-outline" onclick="setAllTools('iridium')">âœ¨ å…¨éƒ¨é“±é‡‘</button>
            <button class="btn btn-outline" onclick="setAllTools('basic')">â†© å…¨éƒ¨é‡ç½®</button>
          </div>
          <div class="tools-grid" id="toolsGrid"></div>
        </div>
      </div>

      <!-- Weapons -->
      <div id="sec-weapons" class="section">
        <div class="card">
          <div class="card-title">âš”ï¸ å·²æ‹¥æœ‰æ­¦å™¨</div>
          <div class="weapon-list" id="weaponList"></div>
          <div class="add-weapon-row">
            <select id="addWeaponSelect"></select>
            <select id="addEnchantSelect"></select>
            <button class="btn btn-gold" onclick="addWeapon()">+ æ·»åŠ </button>
          </div>
        </div>
      </div>

      <!-- Inventory -->
      <div id="sec-inventory" class="section">
        <div class="card">
          <div class="card-title">ğŸ’ èƒŒåŒ…ç‰©å“ <span style="color:var(--text2);font-weight:400;font-size:13px"
              id="invCount"></span></div>
          <table class="inv-table">
            <thead>
              <tr>
                <th>åç§°</th>
                <th>ç‰©å“ID</th>
                <th>æ•°é‡ <span style="color:var(--text2);font-weight:400;font-size:11px">(ä¸Šé™99)</span></th>
                <th>å“è´¨</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="invBody"></tbody>
          </table>
          <div class="add-weapon-row" style="margin-top:12px; flex-wrap: wrap;">
            <div style="flex:1; min-width: 200px; display: flex; flex-direction: column; gap: 4px;">
              <input id="itemSearch" type="text" placeholder="ğŸ” æœç´¢ç‰©å“..." oninput="filterAddItems()"
                style="background:var(--bg);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:6px 10px;font-size:12px;font-family:inherit">
              <select id="addItemSelect"></select>
            </div>
            <input id="addItemQty" type="number" value="1" min="1" max="99"
              style="width:70px;background:var(--bg);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:8px;font-size:13px;font-family:inherit; align-self: flex-end;">
            <select id="addItemQuality" style="width:100px; align-self: flex-end;">
              <option value="normal">æ™®é€š</option>
              <option value="fine">ä¼˜è´¨</option>
              <option value="premium">é¡¶çº§</option>
            </select>
            <button class="btn btn-gold" onclick="addItem()" style="align-self: flex-end;">+ æ–°å¢</button>
          </div>
        </div>
      </div>

      <!-- Farm -->
      <div id="sec-farm" class="section">
        <div class="card">
          <div class="card-title">ğŸŒ¾ å†œç”°åœ°å—</div>
          <div class="batch-row">
            <button class="btn btn-outline" onclick="setAllPlotsGrowth(1)">ğŸŒ± å…¨éƒ¨é‡ç½®ä¸ºç¬¬1å¤©</button>
            <button class="btn btn-outline" onclick="maxAllGrowth()">ğŸŒ¾ å…¨éƒ¨å‚¬ç†Ÿ</button>
            <button class="btn btn-outline" onclick="clearAllWeeds()">ğŸ§¹ æ¸…é™¤æ‚è‰/è™«å®³</button>
            <button class="btn btn-outline" onclick="waterAll()">ğŸ’§ å…¨éƒ¨æµ‡æ°´</button>
          </div>
          <div class="farm-grid" id="farmGrid"></div>
        </div>
      </div>

      <!-- Raw JSON -->
      <div id="sec-raw" class="section">
        <div class="card">
          <div class="card-title">ğŸ“ åŸå§‹JSONæ•°æ® <span
              style="font-weight:400;font-size:12px;color:var(--text2)">ï¼ˆä¿®æ”¹åç‚¹å‡»"åº”ç”¨"åŒæ­¥åˆ°ç¼–è¾‘å™¨ï¼‰</span></div>
          <textarea class="json-raw" id="rawJson"></textarea>
          <div style="margin-top:10px;display:flex;gap:10px">
            <button class="btn btn-gold" onclick="applyRawJson()">åº”ç”¨ä¿®æ”¹</button>
            <button class="btn btn-outline" onclick="refreshRawJson()">åˆ·æ–°</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Plot Edit Modal -->
  <div class="modal-overlay" id="plotModal">
    <div class="modal">
      <h3>ç¼–è¾‘åœ°å— #<span id="plotModalId"></span></h3>
      <div class="field"><label>çŠ¶æ€</label>
        <select id="pm-state">
          <option value="empty">ç©ºåœ°</option>
          <option value="tilled">å·²ç¿»è€•</option>
          <option value="growing">ç”Ÿé•¿ä¸­</option>
          <option value="ready">å¯æ”¶è·</option>
        </select>
      </div>
      <div class="field"><label>ä½œç‰©ID</label><input id="pm-crop" type="text" placeholder="å¦‚ potato"></div>
      <div class="field"><label>å·²ç”Ÿé•¿å¤©æ•°</label><input id="pm-growth" type="number"></div>
      <div class="field"><label>å·²æµ‡æ°´</label><select id="pm-watered">
          <option value="true">æ˜¯</option>
          <option value="false">å¦</option>
        </select></div>
      <div class="field"><label>è™«å®³</label><select id="pm-infested">
          <option value="false">æ— </option>
          <option value="true">æœ‰</option>
        </select></div>
      <div class="field"><label>æ‚è‰</label><select id="pm-weedy">
          <option value="false">æ— </option>
          <option value="true">æœ‰</option>
        </select></div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="closePlotModal()">å–æ¶ˆ</button>
        <button class="btn btn-gold" onclick="savePlotModal()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    const DEFAULT_KEY = 'taoyuanxiang_2024_secret';
    function getKey() {
      return (document.getElementById('encKeyEditor')?.value || document.getElementById('encKey')?.value || DEFAULT_KEY).trim();
    }
    const MAX_STACK = 99;

    // === Data Definitions ===
    const TOOL_NAMES = {
      wateringCan: 'æ°´å£¶', hoe: 'é”„å¤´', pickaxe: 'é•',
      fishingRod: 'é±¼ç«¿', scythe: 'é•°åˆ€', axe: 'æ–§å¤´', pan: 'æ·˜é‡‘ç›˜'
    };
    const TIER_NAMES = { basic: 'åˆå§‹', iron: 'é“åˆ¶', steel: 'ç²¾é’¢', iridium: 'é“±é‡‘' };
    const TIERS = ['basic', 'iron', 'steel', 'iridium'];

    const WEAPONS = {
      wooden_stick: { name: 'æœ¨æ£’', type: 'club', atk: 5, crit: .02 },
      copper_sword: { name: 'é“œå‰‘', type: 'sword', atk: 12, crit: .05 },
      iron_blade: { name: 'é“åˆ€', type: 'sword', atk: 18, crit: .05 },
      war_hammer: { name: 'æˆ˜é”¤', type: 'club', atk: 22, crit: .03 },
      gold_halberd: { name: 'é‡‘æˆŸ', type: 'sword', atk: 28, crit: .08 },
      bone_dagger: { name: 'éª¨åŒ•', type: 'dagger', atk: 9, crit: .15 },
      frost_dagger: { name: 'å†°é”‹åŒ•', type: 'dagger', atk: 16, crit: .18 },
      shadow_blade: { name: 'æš—å½±ä¹‹åˆƒ', type: 'dagger', atk: 24, crit: .22 },
      mud_king_fang: { name: 'æ³¥ç‹ä¹‹ç‰™', type: 'sword', atk: 20, crit: .12 },
      frost_queen_sting: { name: 'å†°éœœä¹‹åˆº', type: 'dagger', atk: 19, crit: .25 },
      lava_lord_maul: { name: 'ç†”å²©ä¹‹é”¤', type: 'club', atk: 38, crit: .08 },
      crystal_shard_dagger: { name: 'æ™¶æ£˜åŒ•', type: 'dagger', atk: 30, crit: .2 },
      shadow_katana: { name: 'æš—å½±å¤ªåˆ€', type: 'sword', atk: 35, crit: .1 },
      void_hammer: { name: 'è™šç©ºæˆ˜é”¤', type: 'club', atk: 48, crit: .05 },
      crystal_blade: { name: 'æ°´æ™¶é•¿å‰‘', type: 'sword', atk: 35, crit: .08 },
      shadow_mace: { name: 'æš—å½±é”¤', type: 'club', atk: 42, crit: .05 },
      void_katana: { name: 'è™šç©ºå¤ªåˆ€', type: 'sword', atk: 52, crit: .1 },
      crystal_king_blade: { name: 'æ™¶ç‹åœ£å‰‘', type: 'sword', atk: 45, crit: .15 },
      shadow_sovereign_fang: { name: 'æš—å½±ä¹‹ç‰™', type: 'dagger', atk: 38, crit: .3 },
      abyss_dragon_mace: { name: 'é¾™ç‹æƒæ–', type: 'club', atk: 60, crit: .12 }
    };
    const ENCHANTMENTS = {
      sharp: { name: 'é”‹åˆ©', desc: 'æ”»å‡»+3' },
      fierce: { name: 'ç‚½çƒ­', desc: 'æ”»å‡»+5' },
      precise: { name: 'ç²¾å‡†', desc: 'æš´å‡»+10%' },
      vampiric: { name: 'å¸è¡€', desc: 'ä¼¤å®³15%å›è¡€' },
      sturdy: { name: 'åšéŸ§', desc: 'å—ä¼¤-15%' },
      lucky: { name: 'å¹¸è¿', desc: 'æ‰ç‡+20%' }
    };
    const TYPE_NAMES = { sword: 'å‰‘', dagger: 'åŒ•é¦–', club: 'é”¤' };

    // === Complete Item Name Map ===
    const ITEM_NAMES = {
      // ä½œç‰©
      cabbage: 'é’èœ', radish: 'èåœ', potato: 'åœŸè±†', tea: 'èŒ¶è‹—', watermelon: 'è¥¿ç“œ',
      rice: 'ç¨»è°·', lotus_root: 'è²è—•', sesame: 'èŠéº»', pumpkin: 'å—ç“œ', sweet_potato: 'çº¢è–¯',
      chrysanthemum: 'èŠèŠ±', osmanthus: 'æ¡‚èŠ±', rapeseed: 'æ²¹èœ', broad_bean: 'èš•è±†',
      spring_shoot: 'æ˜¥ç¬‹', peach: 'æ¡ƒ', green_bean: 'è±†è§’', loofah: 'ä¸ç“œ', eggplant: 'èŒ„å­',
      chili: 'è¾£æ¤’', lotus_seed: 'è²å­', corn: 'ç‰ç±³', yam: 'å±±è¯', peanut: 'èŠ±ç”Ÿ',
      jujube: 'çº¢æ£', persimmon: 'æŸ¿å­', ginger: 'ç”Ÿå§œ', napa_cabbage: 'ç™½èœ', spinach: 'è èœ',
      mustard_green: 'èŠ¥èœ', winter_wheat: 'å†¬å°éº¦', garlic: 'å¤§è’œ', snow_lotus: 'é›ªè²èŠ±',
      soybean: 'å¤§è±†',
      // ç§å­
      seed_cabbage: 'é’èœç§å­', seed_radish: 'èåœç§å­', seed_potato: 'åœŸè±†ç§å­',
      seed_tea: 'èŒ¶è‹—ç§å­', seed_watermelon: 'è¥¿ç“œç§å­', seed_rice: 'ç¨»è°·ç§å­',
      seed_lotus_root: 'è²è—•ç§å­', seed_sesame: 'èŠéº»ç§å­', seed_pumpkin: 'å—ç“œç§å­',
      seed_sweet_potato: 'çº¢è–¯ç§å­', seed_chrysanthemum: 'èŠèŠ±ç§å­', seed_osmanthus: 'æ¡‚èŠ±ç§å­',
      seed_rapeseed: 'æ²¹èœç§å­', seed_broad_bean: 'èš•è±†ç§å­', seed_spring_shoot: 'æ˜¥ç¬‹ç§å­',
      seed_peach: 'æ¡ƒç§å­', seed_green_bean: 'è±†è§’ç§å­', seed_loofah: 'ä¸ç“œç§å­',
      seed_eggplant: 'èŒ„å­ç§å­', seed_chili: 'è¾£æ¤’ç§å­', seed_lotus_seed: 'è²å­ç§å­',
      seed_corn: 'ç‰ç±³ç§å­', seed_yam: 'å±±è¯ç§å­', seed_peanut: 'èŠ±ç”Ÿç§å­',
      seed_jujube: 'çº¢æ£ç§å­', seed_persimmon: 'æŸ¿å­ç§å­', seed_ginger: 'ç”Ÿå§œç§å­',
      seed_napa_cabbage: 'ç™½èœç§å­', seed_spinach: 'è èœç§å­', seed_mustard_green: 'èŠ¥èœç§å­',
      seed_winter_wheat: 'å†¬å°éº¦ç§å­', seed_garlic: 'å¤§è’œç§å­', seed_snow_lotus: 'é›ªè²èŠ±ç§å­',
      seed_soybean: 'å¤§è±†ç§å­',
      // çŸ¿çŸ³ & å®çŸ³
      copper_ore: 'é“œçŸ¿', iron_ore: 'é“çŸ¿', gold_ore: 'é‡‘çŸ¿', crystal_ore: 'æ°´æ™¶çŸ¿',
      shadow_ore: 'æš—å½±çŸ¿', void_ore: 'è™šç©ºçŸ¿', iridium_ore: 'é“±çŸ¿',
      quartz: 'çŸ³è‹±', jade: 'ç¿¡ç¿ ', ruby: 'çº¢å®çŸ³', moonstone: 'æœˆå…‰çŸ³',
      obsidian: 'é»‘æ›œçŸ³', dragon_jade: 'é¾™ç‰', prismatic_shard: 'äº”å½©ç¢ç‰‡', battery: 'ç”µæ± ç»„',
      // é‡‘å±é”­
      copper_bar: 'é“œé”­', iron_bar: 'é“é”­', gold_bar: 'é‡‘é”­', iridium_bar: 'é“±é”­',
      // ææ–™
      wood: 'æœ¨æ', bamboo: 'ç«¹å­', herb: 'è‰è¯', firewood: 'æŸ´ç«',
      pine_cone: 'æ¾æœ', charcoal: 'æœ¨ç‚­', hay: 'å¹²è‰',
      cloth: 'å¸ƒåŒ¹', silk_cloth: 'ä¸ç»¸', alpaca_cloth: 'ç¾Šé©¼ç»’', felt: 'æ¯›æ¯¡',
      rice_flour: 'ç±³ç²‰', wheat_flour: 'é¢ç²‰', cornmeal: 'ç‰ç±³ç²‰',
      pine_resin: 'æ¾è„‚', camphor_oil: 'æ¨Ÿè„‘æ²¹', silk: 'èš•ä¸',
      // æ‚é¡¹
      winter_bamboo_shoot: 'å†¬ç¬‹', wintersweet: 'è…Šæ¢…', wild_mushroom: 'é‡è˜‘è‡',
      ginseng: 'äººå‚', wild_berry: 'é‡æœ', jade_ring: 'ç¿¡ç¿ æˆ’æŒ‡', silk_ribbon: 'ä¸å¸•',
      rain_totem: 'é›¨å›¾è…¾', mulberry: 'æ¡‘è‘š', gold_nugget: 'é‡‘ç ‚',
      trash: 'åƒåœ¾', driftwood: 'æµ®æœ¨', broken_cd: 'ç¢ç¢Ÿç‰‡', soggy_newspaper: 'æ¹¿æŠ¥çº¸',
      scarecrow: 'ç¨»è‰äºº', tapper: 'é‡‡è„‚å™¨', lightning_rod: 'é¿é›·é’ˆ',
      // é±¼ç±»
      crucian: 'é²«é±¼', carp: 'é²¤é±¼', grass_carp: 'è‰é±¼', bass: 'é²ˆé±¼', catfish: 'é²¶é±¼',
      mandarin_fish: 'æ¡‚èŠ±é±¼', eel: 'é³—é±¼', sturgeon: 'é²Ÿé±¼', loach: 'æ³¥é³…', yellow_eel: 'é»„é³',
      snail: 'èœ—ç‰›', freshwater_shrimp: 'æ·¡æ°´è™¾', crab: 'èƒèŸ¹', lobster: 'é¾™è™¾',
      cave_shrimp: 'æ´ç©´è™¾', swamp_crab: 'æ²¼æ³½èŸ¹', crab_pot: 'èŸ¹ç¬¼',
      // é£Ÿç‰© (çƒ¹é¥ª)
      food_stir_fry_cabbage: 'æ¸…ç‚’é’èœ', food_radish_soup: 'èåœæ±¤',
      food_baked_potato: 'çƒ¤åœŸè±†', food_watermelon_juice: 'è¥¿ç“œæ±',
      food_rice_ball: 'é¥­å›¢', food_lotus_root_soup: 'è²è—•æ’éª¨æ±¤',
      food_sesame_ball: 'èŠéº»çƒ', food_pumpkin_pie: 'å—ç“œé¥¼',
      food_sweet_potato_congee: 'çº¢è–¯ç²¥', food_chrysanthemum_wine: 'èŠèŠ±é…’',
      food_osmanthus_cake: 'æ¡‚èŠ±ç³•', food_spring_roll: 'æ˜¥å·',
      food_broad_bean_stir_fry: 'ç‚’èš•è±†', food_bamboo_shoot_soup: 'ç¬‹æ±¤',
      food_peach_dessert: 'æ¡ƒèŠ±é…¥', food_green_bean_stir_fry: 'å¹²ç…¸è±†è§’',
      food_loofah_egg_soup: 'ä¸ç“œè›‹æ±¤', food_braised_eggplant: 'çº¢çƒ§èŒ„å­',
      food_chili_stir_fry: 'è™çš®è¾£æ¤’', food_lotus_seed_soup: 'è²å­ç¾¹',
      food_corn_bread: 'ç‰ç±³é¥¼', food_yam_congee: 'å±±è¯ç²¥',
      food_peanut_crisp: 'èŠ±ç”Ÿé…¥', food_jujube_cake: 'æ£ç³•',
      food_persimmon_cake: 'æŸ¿é¥¼', food_ginger_tea: 'å§œèŒ¶',
      food_napa_cabbage_stew: 'ç™½èœç‚–ç²‰æ¡', food_spinach_soup: 'è èœæ±¤',
      food_pickled_mustard: 'è…ŒèŠ¥èœ', food_steamed_bread: 'é¦’å¤´',
      food_garlic_shrimp: 'è’œè“‰è™¾', food_snow_lotus_tea: 'é›ªè²èŒ¶',
      food_tofu_soup: 'è±†è…æ±¤', food_soybean_milk: 'è±†æµ†',
      food_mushroom_stew: 'è˜‘è‡ç‚–èœ', food_ginseng_soup: 'äººå‚æ±¤',
      food_fried_fish: 'ç…é±¼', food_fish_soup: 'é±¼æ±¤',
      food_crab_soup: 'èŸ¹é»„æ±¤', food_lobster_feast: 'é¾™è™¾å¤§é¤',
      food_miners_lunch: 'çŸ¿å·¥ä¾¿å½“', food_farmers_feast: 'ä¸°æ”¶å®´',
      food_fishers_platter: 'æ¸”å¤«æ‹¼ç›˜', food_tea_set: 'èŒ¶ç‚¹å¥—è£…',
      food_jiaozi: 'å†¬è‡³é¥º', food_laba_congee: 'è…Šå…«ç²¥',
      food_tangyuan: 'å…ƒå®µæ±¤åœ†', food_niangao: 'å¹´ç³•',
      food_bountiful_porridge: 'ä¸°é¥¶ç²¥', food_miners_glory: 'çŸ¿å·¥è£è€€',
      food_chefs_special: 'å¤§å¨ç‰¹åˆ¶', food_anglers_pride: 'é’“è€…ä¹‹å‚²',
      food_silkie_egg_soup: 'ä¹Œé¸¡è›‹æ±¤', food_goat_milk_soup: 'ç¾Šå¥¶æ±¤',
      food_truffle_fried_rice: 'æ¾éœ²ç‚’é¥­', food_peacock_feast: 'å­”é›€å®´',
      food_camel_milk_tea: 'é©¼å¥¶èŒ¶', food_abyss_stew: 'æ·±æ¸Šç‚–èœ',
      food_collectors_banquet: 'çè—ç››å®´',
      // åŠ å·¥å“
      watermelon_wine: 'è¥¿ç“œé…’', osmanthus_wine: 'æ¡‚èŠ±é…¿', rice_vinegar: 'ç±³é†‹',
      pickled_cabbage: 'è…Œç™½èœ', dried_radish: 'èåœå¹²', pumpkin_preserve: 'å—ç“œé…±',
      honey: 'èœ‚èœœ', sesame_oil: 'èŠéº»æ²¹', tea_oil: 'èŒ¶æ²¹',
      peach_wine: 'æ¡ƒèŠ±é…’', jujube_wine: 'çº¢æ£é…’', corn_wine: 'ç‰ç±³é…’',
      pickled_chili: 'æ³¡æ¤’', pickled_ginger: 'è…Œå§œ',
      mayonnaise: 'è›‹é»„é…±', duck_mayonnaise: 'é¸­è›‹é»„é…±', goose_mayonnaise: 'é¹…è›‹é»„é…±',
      silkie_mayonnaise: 'ä¹Œé¸¡è›‹é»„é…±', ostrich_mayonnaise: 'é¸µé¸Ÿè›‹é»„é…±',
      quail_mayonnaise: 'é¹Œé¹‘è›‹é»„é…±', truffle_oil: 'æ¾éœ²æ²¹',
      // çƒŸç†
      smoked_crucian: 'çƒŸç†é²«é±¼', smoked_carp: 'çƒŸç†é²¤é±¼', smoked_grass_carp: 'çƒŸç†è‰é±¼',
      smoked_bass: 'çƒŸç†é²ˆé±¼', smoked_catfish: 'çƒŸç†é²¶é±¼', smoked_mandarin_fish: 'çƒŸç†æ¡‚èŠ±é±¼',
      smoked_eel: 'çƒŸç†é³—é±¼', smoked_sturgeon: 'çƒŸç†é²Ÿé±¼', smoked_loach: 'çƒŸç†æ³¥é³…',
      smoked_yellow_eel: 'çƒŸç†é»„é³',
      // è„±æ°´
      dried_mushroom: 'å¹²è˜‘è‡', dried_peach: 'æ¡ƒå¹²', dried_lychee: 'è”æå¹²',
      dried_persimmon_slice: 'æŸ¿é¥¼', dried_hawthorn: 'å±±æ¥‚ç‰‡', dried_apricot: 'æè„¯',
      dried_berry: 'æœè„¯',
      // èŠ±èœœ
      chrysanthemum_honey: 'èŠèŠ±èœœ', osmanthus_honey: 'æ¡‚èŠ±èœœ',
      rapeseed_honey: 'èœèŠ±èœœ', snow_lotus_honey: 'é›ªè²èœœ',
      // èŒ¶é¥®
      green_tea_drink: 'ç»¿èŒ¶', chrysanthemum_tea: 'èŠèŠ±èŒ¶', osmanthus_tea: 'æ¡‚èŠ±èŒ¶',
      ginseng_tea: 'äººå‚èŒ¶',
      // å¥¶é…ª
      cheese: 'å¥¶é…ª', goat_cheese: 'å±±ç¾Šå¥¶é…ª', buffalo_cheese: 'æ°´ç‰›å¥¶é…ª', yak_cheese: 'ç‰¦ç‰›å¥¶é…ª',
      // è±†è…
      tofu: 'è±†è…', peanut_tofu: 'èŠ±ç”Ÿè±†è…', sesame_paste: 'èŠéº»é…±',
      // è¯å“
      herbal_paste: 'è‰è¯è†', ginseng_extract: 'äººå‚ç²¾', antler_powder: 'é¹¿èŒ¸ç²‰',
      animal_medicine: 'å…½è¯',
      // é¥²æ–™
      premium_feed: 'ç²¾é¥²æ–™', nourishing_feed: 'æ»‹è¡¥é¥²æ–™', vitality_feed: 'æ´»åŠ›é¥²æ–™',
      // é¦™æ–™
      pine_incense: 'æ¾é¦™', camphor_incense: 'æ¨Ÿè„‘é¦™', osmanthus_incense: 'æ¡‚èŠ±é¦™',
      // åŠ¨ç‰©äº§å“
      egg: 'é¸¡è›‹', duck_egg: 'é¸­è›‹', milk: 'ç‰›å¥¶', wool: 'ç¾Šæ¯›',
      rabbit_fur: 'å…”æ¯›', rabbit_foot: 'å¹¸è¿å…”è„š', goose_egg: 'é¹…è›‹', quail_egg: 'é¹Œé¹‘è›‹',
      pigeon_egg: 'é¸½å­è›‹', silkie_egg: 'ä¹Œé¸¡è›‹', peacock_feather: 'å­”é›€ç¾½',
      goat_milk: 'ç¾Šå¥¶', truffle: 'æ¾éœ²', buffalo_milk: 'æ°´ç‰›å¥¶', yak_milk: 'ç‰¦ç‰›å¥¶',
      alpaca_wool: 'ç¾Šé©¼æ¯›', antler_velvet: 'é¹¿èŒ¸', donkey_milk: 'é©´å¥¶',
      camel_milk: 'é©¼å¥¶', ostrich_egg: 'é¸µé¸Ÿè›‹',
      // æœæ ‘
      tree_peach: 'é²œæ¡ƒ', lychee: 'è”æ', mandarin: 'æ©˜å­', plum_blossom: 'æ¢…èŠ±',
      apricot: 'æå­', pomegranate: 'çŸ³æ¦´', hawthorn: 'å±±æ¥‚',
      sapling_peach: 'æ¡ƒæ ‘è‹—', sapling_lychee: 'è”ææ ‘è‹—', sapling_mandarin: 'æ©˜æ ‘è‹—',
      sapling_plum: 'æ¢…æ ‘è‹—', sapling_apricot: 'ææ ‘è‹—', sapling_pomegranate: 'çŸ³æ¦´æ ‘è‹—',
      sapling_persimmon: 'æŸ¿æ ‘è‹—', sapling_hawthorn: 'å±±æ¥‚æ ‘è‹—',
      // æ´’æ°´å™¨
      bamboo_sprinkler: 'ç«¹ç­’æ´’æ°´å™¨', copper_sprinkler: 'é“œç®¡æ´’æ°´å™¨', gold_sprinkler: 'é‡‘ç®¡æ´’æ°´å™¨',
      // è‚¥æ–™
      basic_fertilizer: 'åŸºç¡€è‚¥æ–™', quality_fertilizer: 'ä¼˜è´¨è‚¥æ–™',
      speed_gro: 'ç”Ÿé•¿æ¿€ç´ ', deluxe_speed_gro: 'é«˜çº§æ¿€ç´ ',
      retaining_soil: 'ä¿æ¹¿åœŸ', quality_retaining_soil: 'ä¼˜è´¨ä¿æ¹¿åœŸ',
      // é±¼é¥µ & æµ®æ¼‚
      standard_bait: 'æ™®é€šé±¼é¥µ', wild_bait: 'é‡ç”Ÿé±¼é¥µ', magic_bait: 'é­”æ³•é±¼é¥µ',
      deluxe_bait: 'ç²¾è‡´é±¼é¥µ', targeted_bait: 'å®šå‘é±¼é¥µ',
      spinner: 'æ—‹è½¬æµ®æ¼‚', trap_bobber: 'é™·é˜±æµ®æ¼‚', cork_bobber: 'è½¯æœ¨æµ®æ¼‚',
      quality_bobber: 'å“è´¨æµ®æ¼‚', lead_bobber: 'é“…å æµ®æ¼‚',
      // ç‚¸å¼¹
      cherry_bomb: 'çˆ†ç«¹', bomb: 'ç«è¯åŒ…', mega_bomb: 'é›·ç«å¼¹',
      // åŒ–çŸ³
      trilobite_fossil: 'ä¸‰å¶è™«åŒ–çŸ³', amber: 'ç¥ç€', ammonite_fossil: 'èŠçŸ³åŒ–çŸ³',
      fern_fossil: 'è•¨å¶åŒ–çŸ³', shell_fossil: 'èºå£³åŒ–çŸ³', bone_fragment: 'éª¨éª¸ç¢ç‰‡',
      petrified_wood: 'çŸ³åŒ–æœ¨', dragon_tooth: 'é¾™ç‰™åŒ–çŸ³',
      // å¤ç‰©
      ancient_pottery: 'å¤é™¶ç‰‡', jade_disc: 'ç‰ç’§æ®‹ç‰‡', bronze_mirror: 'é“œé•œ',
      ancient_coin: 'è¿œå¤é“œé’±', oracle_bone: 'ç”²éª¨ç‰‡', jade_pendant: 'ç‰ä½©',
      ancient_seed: 'è¿œå¤ç§å­', bamboo_scroll: 'ç«¹ç®€', stone_axe_head: 'çŸ³æ–§å¤´',
      painted_pottery: 'å½©é™¶ç¢ç‰‡',
      // å…¬ä¼š & ç‰¹æ®Š
      combat_tonic: 'æˆ˜æ–—è¡¥å‰‚', fortify_brew: 'å¼ºåŒ–è¯æ°´', ironhide_potion: 'é“å£è¯å‰‚',
      slayer_charm: 'çŒé­”ç¬¦', warriors_feast: 'å‹‡è€…ç››å®´', monster_lure: 'æ€ªç‰©è¯±é¥µ',
      guild_badge: 'å…¬ä¼šå¾½ç« ',
      // ç€šæµ·
      hanhai_cactus_seed: 'ä»™äººæŒç§å­', hanhai_date_seed: 'çº¢æ£ç§å­',
      hanhai_spice: 'è¥¿åŸŸé¦™æ–™', hanhai_silk: 'ä¸ç»¸', hanhai_turquoise: 'ç»¿æ¾çŸ³',
      hanhai_map: 'è—å®å›¾', mega_bomb_recipe: 'å·¨å‹ç‚¸å¼¹é…æ–¹',
      // æœºå™¨ (machine_xxx IDs)
      machine_wine_barrel: 'é…’å›', machine_preserves_jar: 'è…Œç¼¸',
      machine_oil_press: 'æ²¹åŠ', machine_sauce_jar: 'é…±ç¼¸',
      machine_furnace: 'ç†”ç‚‰', machine_seed_maker: 'ç§å­æœº',
      machine_recycler: 'å›æ”¶æœº', machine_charcoal_kiln: 'ç‚­çª‘',
      machine_flour_mill: 'çŸ³ç£¨', machine_worm_bin: 'èš¯èš“ç®±',
      machine_bee_house: 'èœ‚ç®±', machine_dehydrator: 'è„±æ°´æœº',
      machine_smoker: 'çƒŸç†ç‚‰', machine_cheese_press: 'å¥¶é…ªæœº',
      machine_loom: 'ç»‡å¸ƒæœº', machine_mayonnaise_machine: 'è›‹é»„é…±æœº',
      machine_tea_set: 'èŒ¶å…·', machine_tofu_press: 'è±†è…åŠ',
      machine_herb_grinder: 'è¯ç ”', machine_incense_burner: 'åˆ¶é¦™ç‚‰',
      machine_feed_mixer: 'é¥²æ–™æœº', machine_crystal_duplicator: 'ç»“æ™¶å¤åˆ¶æœº',
      machine_wine_workshop: 'é…’åŠ',
    };
    const itemName = id => ITEM_NAMES[id] || id;

    // === State ===
    let saveData = null;
    let fileName = '';

    // === Crypto ===
    function decrypt(cipher) {
      try {
        const bytes = CryptoJS.AES.decrypt(cipher, getKey());
        const r = bytes.toString(CryptoJS.enc.Utf8);
        return r || null;
      } catch { return null; }
    }
    function encrypt(text) {
      return CryptoJS.AES.encrypt(text, getKey()).toString();
    }

    // === File handling ===
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    dropzone.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('drag-over'); });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('drag-over'));
    dropzone.addEventListener('drop', e => {
      e.preventDefault(); dropzone.classList.remove('drag-over');
      if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', e => { if (e.target.files.length) handleFile(e.target.files[0]); });

    function loadFile() { fileInput.click(); }

    function handleFile(file) {
      fileName = file.name;
      // Sync key from dropzone to editor
      const dk = document.getElementById('encKey').value.trim();
      document.getElementById('encKeyEditor').value = dk;
      const reader = new FileReader();
      reader.onload = e => {
        const raw = e.target.result.trim();
        const json = decrypt(raw);
        if (!json) { toast('è§£å¯†å¤±è´¥ï¼šæ–‡ä»¶æ— æ•ˆæˆ–å¯†é’¥ä¸åŒ¹é…', 'error'); return; }
        try {
          saveData = JSON.parse(json);
          document.getElementById('editor').style.display = 'block';
          dropzone.style.display = 'none';
          document.getElementById('keyRow').style.display = 'none';
          populateAll();
          toast('å­˜æ¡£åŠ è½½æˆåŠŸ', 'success');
        } catch { toast('JSON è§£æå¤±è´¥', 'error'); }
      };
      reader.readAsText(file);
    }

    function populateAll() {
      const g = saveData.game || {};
      const p = saveData.player || {};
      document.getElementById('fileInfo').textContent =
        `${fileName} Â· ${p.playerName || '?'} Â· ç¬¬${g.year}å¹´ ${({ spring: 'æ˜¥', summer: 'å¤', autumn: 'ç§‹', winter: 'å†¬' })[g.season] || g.season} ç¬¬${g.day}å¤©`;

      // Player
      document.getElementById('p-name').value = p.playerName || '';
      document.getElementById('p-gender').value = p.gender || 'male';
      document.getElementById('p-money').value = p.money || 0;
      document.getElementById('p-stamina').value = p.stamina || 0;
      document.getElementById('p-maxStamina').value = p.maxStamina || 0;
      document.getElementById('p-staminaCap').value = p.staminaCapLevel || 0;
      document.getElementById('p-hp').value = p.hp || 0;
      document.getElementById('p-baseMaxHp').value = p.baseMaxHp || 0;

      // Game
      document.getElementById('g-year').value = g.year || 1;
      document.getElementById('g-season').value = g.season || 'spring';
      document.getElementById('g-day').value = g.day || 1;
      document.getElementById('g-hour').value = g.hour || 6;
      document.getElementById('g-weather').value = g.weather || 'sunny';
      document.getElementById('g-tomorrow').value = g.tomorrowWeather || 'sunny';

      renderTools();
      renderWeapons();
      renderInventory();
      renderFarm();
      refreshRawJson();
    }

    // === Sync UI -> Data ===
    function syncToData() {
      if (!saveData) return;
      const p = saveData.player;
      const g = saveData.game;
      p.playerName = document.getElementById('p-name').value;
      p.gender = document.getElementById('p-gender').value;
      p.money = +document.getElementById('p-money').value;
      p.stamina = +document.getElementById('p-stamina').value;
      p.maxStamina = +document.getElementById('p-maxStamina').value;
      p.staminaCapLevel = +document.getElementById('p-staminaCap').value;
      p.hp = +document.getElementById('p-hp').value;
      p.baseMaxHp = +document.getElementById('p-baseMaxHp').value;
      g.year = +document.getElementById('g-year').value;
      g.season = document.getElementById('g-season').value;
      g.day = +document.getElementById('g-day').value;
      g.hour = +document.getElementById('g-hour').value;
      g.weather = document.getElementById('g-weather').value;
      g.tomorrowWeather = document.getElementById('g-tomorrow').value;

      // Tools
      const inv = saveData.inventory;
      if (inv && inv.tools) {
        document.querySelectorAll('.tool-select').forEach(sel => {
          const t = inv.tools.find(x => x.type === sel.dataset.type);
          if (t) t.tier = sel.value;
        });
      }

      // Inventory items
      syncInventory();
    }

    // === Tools ===
    function renderTools() {
      const grid = document.getElementById('toolsGrid');
      const tools = saveData.inventory?.tools || [];
      grid.innerHTML = tools.map(t => `
    <div class="tool-card">
      <div class="tool-name">${TOOL_NAMES[t.type] || t.type}</div>
      <select class="tool-select" data-type="${t.type}">
        ${TIERS.map(tier => `<option value="${tier}" ${t.tier === tier ? 'selected' : ''}>${TIER_NAMES[tier]}</option>`).join('')}
      </select>
    </div>
  `).join('');
    }
    function setAllTools(tier) {
      document.querySelectorAll('.tool-select').forEach(s => s.value = tier);
      if (saveData.inventory?.tools) saveData.inventory.tools.forEach(t => t.tier = tier);
      toast(`å·²å°†æ‰€æœ‰å·¥å…·è®¾ä¸º${TIER_NAMES[tier]}`, 'success');
    }

    // === Weapons ===
    function renderWeapons() {
      const list = document.getElementById('weaponList');
      const owned = saveData.inventory?.ownedWeapons || [];
      const eq = saveData.inventory?.equippedWeaponIndex ?? -1;
      list.innerHTML = owned.map((w, i) => {
        const def = WEAPONS[w.defId] || { name: w.defId, type: '?', atk: 0, crit: 0 };
        const ench = w.enchantmentId ? ENCHANTMENTS[w.enchantmentId] : null;
        const isEq = i === eq;
        return `<div class="weapon-row ${isEq ? 'equipped' : ''}">
      <div style="flex:1">
        <div style="font-size:14px;font-weight:500">${ench ? ench.name + 'çš„' : ''}${def.name}
          <span style="color:var(--text2);font-size:12px">[${TYPE_NAMES[def.type] || def.type}]</span>
          ${isEq ? '<span style="color:var(--gold);font-size:11px;margin-left:4px">å·²è£…å¤‡</span>' : ''}
        </div>
        <div class="weapon-stats">æ”»å‡»:${def.atk} Â· æš´å‡»:${(def.crit * 100).toFixed(0)}%${ench ? ' Â· ' + ench.desc : ''}</div>
      </div>
      ${isEq ? '' : `<button class="btn-sm btn-equip" onclick="equipWeapon(${i})">è£…å¤‡</button>`}
      <button class="btn-sm" onclick="removeWeapon(${i})">åˆ é™¤</button>
    </div>`;
      }).join('');

      // Add weapon selects
      const wsel = document.getElementById('addWeaponSelect');
      wsel.innerHTML = Object.entries(WEAPONS)
        .sort((a, b) => b[1].atk - a[1].atk)
        .map(([id, w]) => `<option value="${id}">${w.name} (${TYPE_NAMES[w.type]} ATK:${w.atk})</option>`).join('');
      const esel = document.getElementById('addEnchantSelect');
      esel.innerHTML = '<option value="">æ— é™„é­”</option>' +
        Object.entries(ENCHANTMENTS).map(([id, e]) => `<option value="${id}">${e.name} - ${e.desc}</option>`).join('');
    }
    function equipWeapon(i) {
      saveData.inventory.equippedWeaponIndex = i;
      renderWeapons();
    }
    function removeWeapon(i) {
      const owned = saveData.inventory.ownedWeapons;
      owned.splice(i, 1);
      if (saveData.inventory.equippedWeaponIndex >= owned.length) saveData.inventory.equippedWeaponIndex = owned.length - 1;
      if (saveData.inventory.equippedWeaponIndex === i) saveData.inventory.equippedWeaponIndex = -1;
      else if (saveData.inventory.equippedWeaponIndex > i) saveData.inventory.equippedWeaponIndex--;
      renderWeapons();
    }
    function addWeapon() {
      const wid = document.getElementById('addWeaponSelect').value;
      const eid = document.getElementById('addEnchantSelect').value || null;
      if (!saveData.inventory.ownedWeapons) saveData.inventory.ownedWeapons = [];
      saveData.inventory.ownedWeapons.push({ defId: wid, enchantmentId: eid });
      renderWeapons();
      toast(`å·²æ·»åŠ  ${WEAPONS[wid]?.name || wid}`, 'success');
    }

    // === Inventory ===
    function renderInventory() {
      const body = document.getElementById('invBody');
      const items = saveData.inventory?.items || [];
      document.getElementById('invCount').textContent = `(${items.length} ä»¶)`;
      body.innerHTML = items.map((it, i) => `<tr>
    <td style="color:var(--gold);font-weight:500">${itemName(it.itemId)}</td>
    <td><input type="text" value="${it.itemId}" data-inv="${i}" data-field="itemId" style="width:140px" oninput="updateItemName(this)"></td>
    <td><input type="number" value="${it.quantity}" data-inv="${i}" data-field="quantity" min="1" max="${MAX_STACK}" title="ä¸Šé™ ${MAX_STACK}" style="width:70px" oninput="this.style.borderColor=this.value>MAX_STACK?'var(--red)':'var(--border)'"></td>
    <td><select data-inv="${i}" data-field="quality" style="background:var(--bg);border:1px solid var(--border);color:var(--text);border-radius:4px;padding:4px 8px;font-size:13px;font-family:inherit">
      <option value="normal" ${it.quality === 'normal' ? 'selected' : ''}>æ™®é€š</option>
      <option value="fine" ${it.quality === 'fine' ? 'selected' : ''}>ä¼˜è´¨</option>
      <option value="premium" ${it.quality === 'premium' ? 'selected' : ''}>é¡¶çº§</option>
    </select></td>
    <td><button class="del-btn" onclick="removeItem(${i})">âœ•</button></td>
  </tr>`).join('');

      // Initial populate if empty
      const sel = document.getElementById('addItemSelect');
      if (!sel.children.length) filterAddItems();
    }
    function filterAddItems() {
      const q = document.getElementById('itemSearch').value.toLowerCase();
      const sel = document.getElementById('addItemSelect');
      const filtered = Object.entries(ITEM_NAMES)
        .filter(([id, n]) => n.toLowerCase().includes(q) || id.toLowerCase().includes(q))
        .sort((a, b) => a[1].localeCompare(b[1], 'zh'));

      sel.innerHTML = filtered.map(([id, n]) => `<option value="${id}">${n} (${id})</option>`).join('');
      if (!filtered.length) sel.innerHTML = '<option value="">æ— åŒ¹é…ç‰©å“</option>';
    }
    function updateItemName(el) {
      const row = el.closest('tr');
      if (row) row.cells[0].textContent = itemName(el.value);
    }
    function addItem() {
      const id = document.getElementById('addItemSelect').value;
      const qty = Math.min(+document.getElementById('addItemQty').value || 1, MAX_STACK);
      const quality = document.getElementById('addItemQuality').value;
      if (!saveData.inventory.items) saveData.inventory.items = [];
      saveData.inventory.items.push({ itemId: id, quantity: qty, quality: quality });
      renderInventory();
      toast(`å·²æ·»åŠ  ${itemName(id)} Ã—${qty}`, 'success');
    }
    function removeItem(i) {
      saveData.inventory.items.splice(i, 1);
      renderInventory();
    }
    function syncInventory() {
      const items = saveData.inventory?.items || [];
      let clamped = false;
      document.querySelectorAll('#invBody input, #invBody select').forEach(el => {
        const idx = +el.dataset.inv;
        const field = el.dataset.field;
        if (items[idx]) {
          if (field === 'quantity') {
            let v = +el.value;
            if (v > MAX_STACK) { v = MAX_STACK; el.value = v; clamped = true; }
            if (v < 1) { v = 1; el.value = v; }
            items[idx][field] = v;
          } else {
            items[idx][field] = el.value;
          }
        }
      });
      if (clamped) toast(`ç‰©å“æ•°é‡å·²é™åˆ¶ä¸ºä¸Šé™ ${MAX_STACK}`, 'error');
    }

    // === Farm ===
    function renderFarm() {
      const grid = document.getElementById('farmGrid');
      const plots = saveData.farm?.plots || [];
      grid.innerHTML = plots.map((p, i) => {
        const cls = [
          'plot-card',
          p.state === 'empty' || !p.cropId ? 'empty' : '',
          p.infested ? 'infested' : '',
          p.weedy ? 'weedy' : ''
        ].filter(Boolean).join(' ');
        return `<div class="${cls}" onclick="openPlotModal(${i})">
      <div class="plot-id">#${p.id ?? i}</div>
      <div class="plot-crop">${p.cropId || 'ç©ºåœ°'}</div>
      <div class="plot-status">${p.state !== 'empty' && p.cropId ? `ç”Ÿé•¿ ${p.growthDays}å¤©` : ''} ${p.watered ? 'ğŸ’§' : ''} ${p.infested ? 'ğŸ›' : ''} ${p.weedy ? 'ğŸŒ¿' : ''}</div>
    </div>`;
      }).join('');
    }
    let editingPlotIdx = -1;
    function openPlotModal(i) {
      editingPlotIdx = i;
      const p = saveData.farm.plots[i];
      document.getElementById('plotModalId').textContent = p.id ?? i;
      document.getElementById('pm-state').value = p.state || 'empty';
      document.getElementById('pm-crop').value = p.cropId || '';
      document.getElementById('pm-growth').value = p.growthDays || 0;
      document.getElementById('pm-watered').value = String(!!p.watered);
      document.getElementById('pm-infested').value = String(!!p.infested);
      document.getElementById('pm-weedy').value = String(!!p.weedy);
      document.getElementById('plotModal').classList.add('show');
    }
    function closePlotModal() { document.getElementById('plotModal').classList.remove('show'); }
    function savePlotModal() {
      const p = saveData.farm.plots[editingPlotIdx];
      p.state = document.getElementById('pm-state').value;
      p.cropId = document.getElementById('pm-crop').value || null;
      p.growthDays = +document.getElementById('pm-growth').value;
      p.watered = document.getElementById('pm-watered').value === 'true';
      p.infested = document.getElementById('pm-infested').value === 'true';
      p.weedy = document.getElementById('pm-weedy').value === 'true';
      closePlotModal();
      renderFarm();
    }
    function setAllPlotsGrowth(d) {
      (saveData.farm?.plots || []).forEach(p => { if (p.cropId) p.growthDays = d; });
      renderFarm(); toast('å·²è®¾ç½®', 'success');
    }
    function maxAllGrowth() {
      (saveData.farm?.plots || []).forEach(p => { if (p.cropId) { p.growthDays = 99; p.state = 'ready'; } });
      renderFarm(); toast('å·²å‚¬ç†Ÿæ‰€æœ‰ä½œç‰©', 'success');
    }
    function clearAllWeeds() {
      (saveData.farm?.plots || []).forEach(p => { p.infested = false; p.weedy = false; p.infestedDays = 0; p.weedyDays = 0; });
      renderFarm(); toast('å·²æ¸…é™¤æ‚è‰ä¸è™«å®³', 'success');
    }
    function waterAll() {
      (saveData.farm?.plots || []).forEach(p => { p.watered = true; p.unwateredDays = 0; });
      renderFarm(); toast('å·²å…¨éƒ¨æµ‡æ°´', 'success');
    }

    // === Raw JSON ===
    function refreshRawJson() {
      syncToData();
      document.getElementById('rawJson').value = JSON.stringify(saveData, null, 2);
    }
    function applyRawJson() {
      try {
        saveData = JSON.parse(document.getElementById('rawJson').value);
        populateAll();
        toast('å·²åº”ç”¨ä¿®æ”¹', 'success');
      } catch { toast('JSON æ ¼å¼é”™è¯¯', 'error'); }
    }

    // === Export ===
    function exportSave() {
      syncToData();
      saveData.savedAt = new Date().toISOString();
      const json = JSON.stringify(saveData);
      const cipher = encrypt(json);
      const blob = new Blob([cipher], { type: 'application/octet-stream' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = fileName || 'å­˜æ¡£.tyx';
      a.click();
      URL.revokeObjectURL(a.href);
      toast('å­˜æ¡£å·²å¯¼å‡º', 'success');
    }

    // === Tabs ===
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('sec-' + tab.dataset.tab).classList.add('active');
        if (tab.dataset.tab === 'raw') refreshRawJson();
      });
    });

    // === Toast ===
    function toast(msg, type = '') {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = 'toast ' + type + ' show';
      clearTimeout(t._tid);
      t._tid = setTimeout(() => t.classList.remove('show'), 2500);
    }
  </script>
</body>

</html>